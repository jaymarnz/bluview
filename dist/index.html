<!DOCTYPE html><html><head><title>BluView: Display for BluOS Streamers</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon sizes=180x180 href=apple-touch-icon.png><link rel=icon sizes=32x32 href=favicon-32x32.png><link rel=icon sizes=120x120 href=favicon-120x120.png><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap"><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/x2js/1.2.0/xml2json.min.js integrity="sha512-HX+/SvM7094YZEKOCtG9EyjRYvK8dKlFhdYAnVCGNxMkA59BZNSZTZrqdDlLXp0O6/NjDb1uKnmutUeuzHb3iQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><style>@import url(https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap);*{font-family:Roboto,Verdana,Arial,Helvetica,sans-serif}body{background-color:#000;color:#e3e3e3;position:absolute;font-size:125%;top:0;bottom:0;left:0;right:0}input[type=text]{height:1.5em;background-color:#c3c3c3;color:#000;font-size:1em;font-weight:700}input[type=button]{height:2em;font-size:125%;font-weight:700;min-width:6em;margin-top:.5em;text-align:center;background-color:#d2691e;color:#e3e3e3}input[type=button]:disabled{background-color:#7e7e7e;opacity:25%}form{text-align:center}h1{text-align:center;margin-top:0}p{margin-top:.25em}.paraHead{font-size:110%;font-weight:700}.run{display:none;height:100%}.config{display:none;height:100%}.notPlaying{display:flex;justify-content:center;align-items:center;height:100%}.notPlaying .timeOfDay{text-align:center;font-size:12em;font-weight:700}.playing{display:flex;align-items:center;height:100%}.playingContainer{display:flex;height:400px;width:100%}.left{width:400px}.right{display:flex;flex-direction:column;flex:1;margin-left:15px;min-width:0}.bottom{margin-top:auto}.text{text-overflow:ellipsis;overflow:hidden;white-space:nowrap}.timeOfDay{display:block;font-size:6em;font-weight:700;line-height:1em}.today{display:block;text-align:center;font-size:2.5em;padding-bottom:.5em}.notmuted{background-image:url('data:image/svg+xml; utf8,<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M320,320c9.74-19.38,16-40.84,16-64,0-23.48-6-44.42-16-64" stroke="%23e3e3e3" stroke-linecap="square" stroke-miterlimit="10" stroke-width="32px" fill="none"/><path d="M368,368c19.48-33.92,32-64.06,32-112s-12-77.74-32-112" stroke="%23e3e3e3" stroke-linecap="square" stroke-miterlimit="10" stroke-width="32px" fill="none"/><path d="M416,416c30-46,48-91.43,48-160S446,143,416,96" stroke="%23e3e3e3" stroke-linecap="square" stroke-miterlimit="10" stroke-width="32px" fill="none"/><polygon fill="%23e3e3e3" points="125.65 176.1 32 176.1 32 335.9 125.65 335.9 256 440 256 72 125.65 176.1"/></svg>');background-position:left center;background-repeat:no-repeat;background-size:contain}.muted{background-image:url('data:image/svg+xml; utf8,<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><line x1="416" y1="432" x2="64" y2="80" stroke="%23e3e3e3" stroke-linecap="square" stroke-miterlimit="10" stroke-width="32px" fill="none"/><polygon fill="%23e3e3e3" points="256 72 182.4 130.78 256 204.37 256 72"/><polygon fill="%23e3e3e3" points="32 176.1 32 335.9 125.65 335.9 256 440 256 339.63 92.47 176.1 32 176.1"/></svg>');background-position:left center;background-repeat:no-repeat;background-size:contain}#image{width:400px;height:400px;padding-right:20px}#title1{font-size:3em;font-weight:700}#title2{margin-block-start:.25em;font-size:2em;font-weight:700}#title3{margin-block-start:.25em;font-size:1.5em;font-weight:400}#timeOfDay{padding-top:18px}#streamInfo{display:flex;align-items:center}#serviceIcon{display:inline-block;width:32px;height:32px;margin-right:16px}#quality,#serviceName,#streamFormat{display:inline;font-size:1em;font-weight:400;margin-right:.25em}#volume{height:42px;width:100%;display:flex;align-items:center}#volume_box{margin-left:50px;height:80%;width:100%;border:1px solid #e3e3e3}#volume_level{height:100%;width:0}.muted #volume_level{background-color:#c3c3c3}.notmuted #volume_level{background-color:#e3e3e3}#configForm{display:flex;flex-direction:column;align-items:center}#errorMessage{display:none;color:red;margin:.5em auto;text-align:center}#errorMessage p{margin:0;line-height:1.5em}#spinner{display:none;margin:.5em auto}</style><style>.lds-ring{display:inline-block;position:relative;width:64px;height:64px}.lds-ring div{box-sizing:border-box;display:block;position:absolute;width:42px;height:42px;margin:5px;border:5px solid #e3e3e3;border-radius:50%;animation:lds-ring 1.2s cubic-bezier(.5,0,.5,1) infinite;border-color:#e3e3e3 transparent transparent transparent}.lds-ring div:nth-child(1){animation-delay:-.45s}.lds-ring div:nth-child(2){animation-delay:-.3s}.lds-ring div:nth-child(3){animation-delay:-.15s}@keyframes lds-ring{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}</style><script>const configlocalStorage="bluview-config",defaultConfig={playerIP:void 0,dialServerIP:void 0,dialserverDefaultPort:3e3,pollTimeout:100};async function getConfig(e){var r={...defaultConfig,...e||{},...JSON.parse(localStorage.getItem(configlocalStorage)||"{}")};for(r.priorIP&&$("#ip_address").val(r.priorIP),r.priorDialServerIP&&$("#ds_address").val(r.priorDialServerIP);!r.playerIP;){var{playerIP:a,dialServerIP:i}=await getPlayerIP(r);a&&(r.playerIP=a,r.dialServerIP=i,localStorage.setItem(configlocalStorage,JSON.stringify({playerIP:a,dialServerIP:i})))}return r}async function getPlayerIP(e){let r,a;for(enableButtonIfValidIP("#ip_address","#btnConfig");!r;){$("#config").show();try{$("#btnConfig").show(),$("#spinner").hide();var i=await configButtonClick();if($("#errorMessage").hide(),$("#btnConfig").hide(),$("#spinner").show(),i.ds_address&&!isValidIpPort(i.ds_address))throw new Error("Invalid DialServer IP Address. Leave blank if you don't have a DialServer");a=i.ds_address||"";var t=await playerRequest("SyncStatus",{...e,playerIP:i.ip_address,fetchTimeout:1e4,errorMessage:"Error connecting to the player<br>Check the IP address is correct and reachable"});if(t&&t.SyncStatus){if("true"!==t.SyncStatus._initialized)throw new Error("The player needs to be setup with the BluOS Controller app");r=i.ip_address}}catch(e){$("#errorMessageText").html(e.message||e.toLocaleString()),$("#errorMessage").show()}return $("#config").hide(),{playerIP:r,dialServerIP:a}}}async function configButtonClick(){return new Promise((e,r)=>{$("#btnConfig").click(()=>{e({ip_address:$("#ip_address").val(),ds_address:$("#ds_address").val()})})})}</script><script>let config={disableLongPoll:!1,logStatus:!1},state={};async function run(){for(config=await getConfig(config),$("#playing").hide(),$("#notPlaying").show(),$("#run").show(),updateTime(),setInterval(updateTime,250),config.dialServerIP&&enableVolumeManagement(config);;){try{await updatePlayer()}catch(t){etag=void 0,console.log(t)}await sleep(canLongPoll()?1e3:3e4)}}$(async function(){$("#notPlaying").click(()=>{localStorage.setItem(configlocalStorage,JSON.stringify({priorIP:config.playerIP,priorDialServerIP:config.dialServerIP})),location.reload()}),await run()});let etag;function canLongPoll(){return etag&&config.pollTimeout&&!config.disableLongPoll}async function updatePlayer(){let t="Status";canLongPoll()&&(t+=`?timeout=${config.pollTimeout}&etag=`+etag),state=(state=await playerRequest(t,{fetchTimeout:canLongPoll()?1e3*config.pollTimeout+1e3:3e4,...config})).status||{},etag=state._etag,updateDisplay()}function isPlaying(){return"play"===state.state||"stream"===state.state}function isMute(){var t=parseInt(state.mute);if(t<0||1<t)throw new Error("invalid mute value: "+t);return t}function updateDisplay(){if(config.logStatus&&console.log(state),isPlaying()){$("#playing").show(),$("#notPlaying").hide(),setImageSrc($("#image"),state.image,config),$("#title1").html(state.title1||""),$("#title2").html(state.title2||""),$("#title3").html(state.title3||""),$("#timeOfDay").css("fontSize",state.title1&&(state.title2||state.title3)?"6em":"10em"),setImageSrc($("#serviceIcon"),state.serviceIcon,config);let t;t=isNaN(state.quality)?(state.quality||"").toString().toUpperCase():state.quality/1e3+" Kbps",$("#quality").html("MQAAUTHORED"===t?"MQA (AUTH)":t),$("#streamFormat").html(state.streamFormat||""),$("#volume").attr("class","1"===state.mute?"muted":"notmuted"),$("#volume_level").width(("1"===state.mute?state.muteVolume:state.volume)+"%")}else $("#playing").hide(),$("#notPlaying").show()}function updateTime(){const t=new Date;$(".timeOfDay").each(function(){$(this).html(t.getHours().toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0"))}),$(".today").each(function(){$(this).html(formatDate(t))})}function formatDate(t){var[t,e,a,i]=[t.getDay(),t.getMonth(),t.getDate(),t.getFullYear()];return["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][t]+` ${["January","February","March","April","May","June","July","August","September","October","November","December"][e]} ${a}, `+i}</script><script>const x2js=new X2JS;function playerRequest(t,s){return new Promise((a,n)=>{var e=_bluosURL(t,s);$.ajax({url:e,type:"get",dataType:"xml",timeout:s.fetchTimeout}).done((e,t,r)=>a(x2js.xml2json(r.responseXML))).fail((e,t,r)=>n(new Error(s.errorMessage||("timeout"===r?"Player request timed out":`Error conmmunicating with the player ${r?"("+r+")":""}<br>Check the IP address is correct and reachable`))))})}function setImageSrc(e,t,r){t?(e.attr("src",_bluosURL(t,r)),e.show()):e.hide()}function _bluosURL(e,t){t=`http://${t.playerIP}:11000/`;return e&&(e.match(/https?:\/\//)?e:t+e.replace(/^\//,""))}function sleep(t){return new Promise(e=>setTimeout(e,t))}const IpPatternStr="(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)",IpPattern=new RegExp("^"+IpPatternStr+"$"),IpPortPattern=new RegExp("^"+IpPatternStr+"(:[0-9]+)?$");function isValidIpPort(e){e=e.match(IpPortPattern);return!!e&&(!e[6]||1<=e[6]&&e[6]<=65535)}function enableButtonIfValidIP(t,r){let a=46;$(r).prop("disabled",!IpPattern.test($(t).val())),$(t).keypress(e=>{if(8!=e.which&&0!=e.which&&e.which!=a&&(e.which<48||57<e.which))return $(r).prop("disabled",!0),!1}).keyup(()=>{var e=$(t);if(IpPattern.test(e.val()))a=0,"."==e.val().substr(e.val().length-1)&&e.val(e.val().slice(0,-1)),4==e.val().split(".").length&&$(r).prop("disabled",!1);else{for($(r).prop("disabled",!0);-1!==e.val().indexOf("..");)e.val(e.val().replace("..","."));a=46}})}</script><script>const connectRetryTime=5e3,keepAliveTime=3e4,longPressTime=500,volumeCacheTime=1e3;let webSocket,keepAliveTimer,connectionFailed,currentVolume,volumeTimeout,buttonDownTimeout;async function enableVolumeManagement(e){for(;;)webSocket||connect(e),await sleep(connectRetryTime)}function connect(t){if(t.dialServerIP){let e="ws://"+t.dialServerIP;/^.+:([0-9]+)$/.test(e)||(e+=":"+t.dialserverDefaultPort),t.logStatus&&console.log("connecting to dialServer at",e),(webSocket=new WebSocket(e)).onmessage=e=>{e=JSON.parse(e.data);e.degrees&&isPlaying()?adjustVolume(e,t):e.button&&buttonClick(e,t)},webSocket.onopen=()=>{t.logStatus&&console.log("connected to dialServer"),keepAliveTimer=setInterval(()=>webSocket.send(""),keepAliveTime)},webSocket.onclose=()=>{t.logStatus&&console.log("connection closed to dialServer"),clearTimeout(keepAliveTimer),webSocket=void 0},webSocket.onerror=e=>{t.logStatus&&console.log("connection error with dialServer"),webSocket.readyState===webSocket.OPEN&&webSocket.close(),webSocket=void 0}}}function buttonClick(e,t){switch(e.button){case"down":t.logStatus&&console.log("button down"),clearTimeout(buttonDownTimeout),buttonDownTimeout=setTimeout(()=>{buttonDownTimeout=void 0,t.logStatus&&console.log("button down timeout - activating longPress"),longPress(t)},longPressTime);break;case"up":t.logStatus&&console.log("button up with buttonDownTimeout = "+buttonDownTimeout),buttonDownTimeout&&(clearTimeout(buttonDownTimeout),buttonDownTimeout=void 0,shortPress(t))}}function shortPress(e){e.logStatus&&console.log(`shortPress in state: ${state.state}, mute: `+state.mute),"pause"===state.state?longPress(e):isPlaying()&&toggleMute(e)}function longPress(e){e.logStatus&&console.log(`shortPress in state: ${state.state}, mute: `+state.mute),"pause"===state.state?(pausePlay(e,!1),isMute()&&setMute(e,0)):isPlaying()&&pausePlay(e,!0)}function toggleMute(e){e.logStatus&&console.log("toggleMute"),setMute(e,1-isMute())}function setMute(e,t){e.logStatus&&console.log("setMute: "+t),playerRequest("Volume?mute="+t,e).catch(e=>console.error(e))}function pausePlay(e,t){e.logStatus&&console.log("pausePlay: "+t),playerRequest(t?"Pause":"Play",e).catch(e=>console.error(e))}function adjustVolume(e,t){currentVolume=void 0!==currentVolume?currentVolume:"1"===state.mute?state.muteVolume:state.volume;let o=Math.round(Math.abs(e.degrees)/270*100)*Math.sign(e.degrees);0===o&&(o=+Math.sign(e.degrees)),t.logStatus&&console.log(`adjustVolume: { degrees: ${e.degrees}, volume: ${currentVolume}, adjustment: `+o);e=Math.max(Math.min(parseInt(currentVolume)+o,100),0);0<=e&&e<=100&&(currentVolume=e,state.volume=e.toString(),updateDisplay(),clearTimeout(volumeTimeout),volumeTimeout=setTimeout(()=>currentVolume=void 0,volumeCacheTime),playerRequest("Volume?level="+e,t).then(e=>{state.volume=e.__text,updateDisplay()}).catch(e=>console.error(e)))}</script></head><body><div class=run id=run><div class=notPlaying id=notPlaying><div><div class=timeOfDay></div><div class=today></div></div></div><div class=playing id=playing><div class=playingContainer><div class=left><img id=image></div><div class=right><div class=text id=title1></div><div class=text id=title2></div><div class=text id=title3></div><div class=timeOfDay id=timeOfDay></div><div class=bottom><div id=streamInfo><img id=serviceIcon><div id=quality></div><div id=streamFormat></div></div><div class=muted id=volume><div id=volume_box><div id=volume_level width=0></div></div></div></div></div></div></div></div><div class=config id=config><div><h1>BluView - Display for BluOS&trade; Streamers</h1><p>This app runs in most modern browsers to continuously display what's playing. It includes the current time since it's handy to also use it as a clock. And when nothing is playing it's just a clock.</p><p><span class=paraHead>Privacy: </span>It runs entirely within your browser and there is no data sent or stored anywhere else. It saves the configuration data below within your browser's local storage.</p><p><span class=paraHead>Configuration: </span>You only need to configure the IP address of your streamer. You'll find this in the BluOS app under Help -> Diagnostics. You should only need to do this once or if the address changes.</p><p>You can use a Microsoft Surface Dial to control volume, mute, and pause/play. To do this you'll need to be running DialServer and enter its IP address along with the port. If you don't specify a port it uses 3000 by default.</p><form id=configForm><table><tr><td><label for=ip_address>Your BluOS streamer's IP Address:</label></td><td><input type=text id=ip_address name=ip_address placeholder="eg. 192.168.1.50"></td></tr><tr><td><label for=ds_address>DialServer IP Address and Port (optional):</label></td><td><input type=text id=ds_address name=ds_address placeholder="eg. 192.168.1.60:3000"></td></tr></table><div><input type=button id=btnConfig value=Configure></div></form><div class=lds-ring id=spinner><div></div><div></div><div></div><div></div></div><div id=errorMessage><p id=errorMessageText></p></div></div></div></body></html>